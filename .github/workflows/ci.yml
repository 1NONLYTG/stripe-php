name: CI

on: 
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  tests:
    name: Tests

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        env:
          # - AUTOLOAD=0
          - AUTOLOAD=1
        php-version:
          #- "5.6"
          #- "7.0"
          #- "7.1"
          #- "7.2"
          - "7.3"
            #- "7.4"
            #- "8.0"
            #- "8.1"
    container:
      imagename:php:${{ matrix.php-version }}-cli-buster
    steps:
      - uses: actions/checkout@master

      - name: Validate composer.json and composer.lock
        run: composer validate

      - name: Get Composer Cache Directory
        id: composer-cache
        run: |
          echo "::set-output name=dir::$(composer config cache-files-dir)"
      - uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Start stripe-mock
        run: docker run -d -p 12111-12112:12111-12112 stripemock/stripe-mock && sleep 5

      - name: Run test suite
        run: |
          php --version
          ./build.php $env:AUTOLOAD

      # - name: Send code coverage report to coveralls.io
      #   run: vendor/bin/php-coveralls -c .coveralls.github-actions.yml -v
      #   env:
      #     COVERALLS_RUN_LOCALLY: 1
      #     COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
